<!DOCTYPE html>
<html>
<head>
  	<meta charset="utf-8">
  	<meta name="viewport" content="initial-scale=1, width=device-width">
  	
  	<!-- <link rel="stylesheet"  href="./chatroom.css" /> -->
  	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jost:wght@400;700&display=swap" />
  	
  	
  	
</head>
<body>
  	
  	<div class="chatroom">
    		<div class="chatroom1">
      			<b class="dragoman">Dragoman</b>
      			<div class="ui">
        				<div class="video">
          					<div class="your-camera">
								<video id="myVideo" autoplay playsinline muted width="100"></video>
          					</div>
          					<div class="peer-camera">
								<video id="peerVideo" autoplay playsinline class="w-full max-w-md rounded-lg shadow-md" width="100"></video>
          					</div>
        				</div>
        				<div class="transcription">
          					<div class="title-frame">
            						<b class="transcription1">Transcription</b>
          					</div>
          					<div class="message-history">
            						<div class="message-wrap">
              							<div class="message">
                								<div class="this-is-a">Kid named finger kid named binger</div>
              							</div>
            						</div>
            						<div class="message-wrap1">
              							<div class="message1">
                								<div class="this-is-a">坚持另一个坚持另一个坚持另一个坚持另一个坚持另一个</div>
              							</div>
            						</div>
            						<div class="message-wrap">
              							<div class="message2">
                								<div class="this-is-a">Hi there! I’m from the US. How are you?</div>
              							</div>
            						</div>
            						<div class="message-wrap1">
              							<div class="message3">
                								<div class="this-is-a">嘿。我很好。你怎么样？</div>
              							</div>
            						</div>
            						<div class="message-wrap">
              							<div class="message2">
                								<div class="this-is-a">It's beautiful, especially the food and the historical places. Ever been here?</div>
              							</div>
            						</div>
            						<div class="message-wrap1">
              							<div class="message3">
                								<div class="this-is-a">没有，但我很想有一天去看看。我听说那里的建筑很棒。你最喜欢住在那里的哪一点？</div>
              							</div>
            						</div>
          					</div>
        				</div>
        				<div class="translator">
          					<div class="translator-wrapper">
            						<b class="translator1">Translator</b>
          					</div>
          					<div class="translation-history">
            						<div class="message-wrap6">
              							<div class="message6">
                								<div class="this-is-a">嘿。我很好。你怎么样？</div>
              							</div>
            						</div>
            						<div class="message-wrap7">
              							<div class="message1">
                								<div class="this-is-a">Hey. I'm fine. How are you?</div>
              							</div>
            						</div>
            						<div class="message-wrap7">
              							<div class="message6">
                								<div class="this-is-a">没有，但我很想有一天去看看。我听说那里的建筑很棒。你最喜欢住在那里的哪一点？</div>
              							</div>
            						</div>
            						<div class="message-wrap7">
              							<div class="message1">
                								<div class="this-is-a">No, but I'd love to visit someday. I hear the architecture is amazing. What's your favorite thing about living there?</div>
              							</div>
            						</div>
          					</div>
        				</div>
      			</div>
    		</div>
  	</div>

	<script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>
	<script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>

	<script>
        const socket = io("/");  // Make sure to include socket.io client library
        const peer = new Peer(); // Make sure to include Peer.js library

        let isSocketConnected = false;
        let roomId = '';
        let videoDevices = [];
        let selectedDeviceId = '';
        let userStream = null;

        const connectButton = document.getElementById("connectButton");
        const roomIdInput = document.getElementById("roomId");
        const socketStatus = document.getElementById("socketStatus");
        const cameraSelect = document.getElementById("cameraSelect");
        const myVideo = document.getElementById("myVideo");
        const peerVideo = document.getElementById("peerVideo");

        // Setup connection status
        socket.on("connect", () => {
            isSocketConnected = true;
            socketStatus.textContent = "Socket Status: Connected";
            connectButton.disabled = false;
            getRoom();
        });

        socket.on("disconnect", () => {
            isSocketConnected = false;
            socketStatus.textContent = "Socket Status: Not Connected";
            connectButton.disabled = true;
        });

        // Fetch video devices
        async function fetchDevices() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            videoDevices = devices.filter(device => device.kind === "videoinput");
            videoDevices.forEach(device => {
                const option = document.createElement("option");
                option.value = device.deviceId;
                option.textContent = device.label || `Camera ${device.deviceId}`;
                cameraSelect.appendChild(option);
            });

            if (videoDevices.length > 0) {
                selectedDeviceId = videoDevices[0].deviceId; // Default to first camera
                cameraSelect.value = selectedDeviceId;
            }
        }

        function getRoom() {
            // Get the current URL's query string
            const queryString = window.location.search;

            // Create a URLSearchParams object
            const urlParams = new URLSearchParams(queryString);

            // Get the value of a specific parameter
            const speak = urlParams.get('speak');

            const learn = urlParams.get('learn');
            if (isSocketConnected) {
                socket.emit("find-room", { speak, learn })
            }
        }
        socket.on("matched-room", joinRoom)

        // Join room
        async function joinRoom(roomId) {
            console.log(roomId)
            // Get user media (camera) based on selected device
            userStream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: selectedDeviceId },
                audio: true
            });
            myVideo.srcObject = userStream;
            // Emit room join signal
            socket.emit("join-room", { roomId, peerId: peer.id });

            socket.on("room-peers", peers => {
                console.log(peers)
                peers.forEach(otherPeerId => {
                    const call = peer.call(otherPeerId, userStream);
                    call.on("stream", remoteStream => {
                        peerVideo.srcObject = remoteStream;
                    });
                });

                peer.on("call", call => {
                    call.answer(userStream);
                    call.on("stream", remoteStream => {
                        peerVideo.srcObject = remoteStream;
                    });
                });
            });
        }

        // Handle UI interactions
        roomIdInput.addEventListener("input", (e) => {
            roomId = e.target.value;
        });

        connectButton.addEventListener("click", () => {
            joinRoom();
        });

        cameraSelect.addEventListener("change", (e) => {
            selectedDeviceId = e.target.value;
        });

        // Initialize video devices
        fetchDevices();
    </script>
  	
</body>
</html>